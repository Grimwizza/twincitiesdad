---
import { localEvents, type Event } from "../data/events";
import EventCard from "./EventCard.astro";

// Sort events by date
const sortedEvents = [...localEvents].sort(
	(a, b) => a.date.getTime() - b.date.getTime(),
);

// Group events
const now = new Date();
const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
const tomorrow = new Date(today);
tomorrow.setDate(tomorrow.getDate() + 1);
const nextWeek = new Date(today);
nextWeek.setDate(nextWeek.getDate() + 7);
const nextMonth = new Date(today);
nextMonth.setMonth(nextMonth.getMonth() + 1);

// Date formatting helpers
const formatDate = (date: Date) =>
	date.toLocaleDateString("en-US", { month: "short", day: "numeric" });
const weekStart = new Date(today);
weekStart.setDate(weekStart.getDate() + 1);
const weekEnd = new Date(nextWeek);
weekEnd.setDate(weekEnd.getDate() - 1);
const weekRange = `${formatDate(weekStart)} - ${formatDate(weekEnd)}`;

const monthStart = new Date(nextWeek);
const monthEnd = new Date(nextMonth);
monthEnd.setDate(monthEnd.getDate() - 1);
const monthRange = `${formatDate(monthStart)} - ${formatDate(monthEnd)}`;

const groups = {
	today: [] as Event[],
	week: [] as Event[],
	month: [] as Event[],
	upcoming: [] as Event[],
};

sortedEvents.forEach((event) => {
	const eventDate = new Date(event.date);
	// Reset time for comparison
	const eventDay = new Date(
		eventDate.getFullYear(),
		eventDate.getMonth(),
		eventDate.getDate(),
	);

	if (eventDay < today) return; // Past events

	if (eventDay.getTime() === today.getTime()) {
		groups.today.push(event);
	} else if (eventDay < nextWeek) {
		groups.week.push(event);
	} else if (eventDay < nextMonth) {
		groups.month.push(event);
	} else {
		groups.upcoming.push(event);
	}
});
---

<div class="events-container">
	{
		groups.today.length > 0 && (
			<section class="event-group">
				<h2 class="group-title">ğŸ”¥ Happening Today</h2>
				<div class="event-list">
					{groups.today.map((event) => (
						<EventCard event={event} />
					))}
				</div>
			</section>
		)
	}

	{
		groups.week.length > 0 && (
			<section class="event-group">
				<h2 class="group-title">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						width="24"
						height="24"
						viewBox="0 0 24 24"
						fill="none"
						class="title-icon"
						stroke="currentColor"
						stroke-width="2"
						stroke-linecap="round"
						stroke-linejoin="round"
					>
						<>
							<rect
								x="3"
								y="4"
								width="18"
								height="18"
								rx="2"
								ry="2"
							/>
							<line x1="16" y1="2" x2="16" y2="6" />
							<line x1="8" y1="2" x2="8" y2="6" />
							<line x1="3" y1="10" x2="21" y2="10" />
						</>
					</svg>
					This Week
				</h2>
				<div class="event-list">
					{groups.week.map((event) => (
						<EventCard event={event} />
					))}
				</div>
			</section>
		)
	}

	{
		groups.month.length > 0 && (
			<section class="event-group">
				<h2 class="group-title">ğŸ—“ï¸ This Month</h2>
				<div class="event-list">
					{groups.month.map((event) => (
						<EventCard event={event} />
					))}
				</div>
			</section>
		)
	}

	{
		groups.upcoming.length > 0 && (
			<section class="event-group">
				<h2 class="group-title">ğŸ”® Upcoming</h2>
				<div class="event-list">
					{groups.upcoming.map((event) => (
						<EventCard event={event} />
					))}
				</div>
			</section>
		)
	}

	{
		sortedEvents.length === 0 && (
			<div class="empty-state">
				<p>No upcoming events found via our local feed.</p>
			</div>
		)
	}

	<!-- Dynamic empty state shown by JS when filters return no results -->
	<div
		id="filtered-empty-state"
		class="empty-state filtered-empty"
		style="display: none;"
	>
		<p>ğŸ˜• No events match your current filters.</p>
		<button id="clear-filters-btn" class="clear-filters-btn"
			>Clear All Filters</button
		>
	</div>
</div>

<style>
	.events-container {
		display: flex;
		flex-direction: column;
		gap: 3rem;
	}

	.event-group {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.group-title {
		font-size: 1.5rem;
		color: var(--text-primary);
		padding-bottom: 0.5rem;
		border-bottom: 1px solid var(--bg-tertiary);
	}

	.event-list {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.group-title {
		font-size: 1.5rem;
		color: var(--text-primary);
		padding-bottom: 0.5rem;
		border-bottom: 1px solid var(--bg-tertiary);
		display: flex;
		align-items: center;
		gap: 0.75rem;
	}

	.title-icon {
		color: var(--accent-light);
	}

	.event-list {
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.empty-state {
		text-align: center;
		padding: 4rem 2rem;
		color: var(--text-muted);
	}

	.filtered-empty p {
		font-size: 1.2rem;
		margin-bottom: 1rem;
	}

	.clear-filters-btn {
		background: var(--accent);
		color: white;
		border: none;
		padding: 0.75rem 1.5rem;
		border-radius: 9999px;
		font-size: 0.9rem;
		font-weight: 500;
		cursor: pointer;
		transition:
			background var(--transition-fast),
			transform var(--transition-fast);
	}

	.clear-filters-btn:hover {
		background: var(--accent-light);
		transform: scale(1.02);
	}
</style>
