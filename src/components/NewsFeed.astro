---
// News Feed Component - Fetches Minnesota news from RSS feeds
// Uses local TC news sources (RSS) and falls back to curated list

interface NewsItem {
	title: string;
	link: string;
	source: string;
	image?: string;
	pubDate?: string;
}

// Static news sources with RSS feeds
const NEWS_SOURCES = [
	{ name: 'Star Tribune', rss: 'https://www.startribune.com/local/index.rss2' },
	{ name: 'MPR News', rss: 'https://www.mprnews.org/feed' },
	{ name: 'Pioneer Press', rss: 'https://www.twincities.com/feed/' },
	{ name: 'KARE 11', rss: 'https://www.kare11.com/feeds/syndication/rss/news/local' },
];
---

<section class="news-section">
	<div class="section-header">
		<h2>ðŸ“° Minnesota News</h2>
		<span class="section-subtitle">Latest headlines from the Twin Cities</span>
	</div>
	
	<div class="news-grid" id="news-grid">
		<div class="news-loading">
			<p>Loading latest news...</p>
		</div>
	</div>
	
	<div class="news-sources">
		<span>Sources: Star Tribune, MPR News, Pioneer Press, KARE 11</span>
	</div>
</section>

<style>
	.news-section {
		padding: 3rem 1.5rem;
		max-width: 1200px;
		margin: 0 auto;
	}
	
	.section-header {
		margin-bottom: 2rem;
	}
	
	.section-header h2 {
		font-size: 1.75rem;
		margin-bottom: 0.25rem;
		color: var(--text-primary);
	}
	
	.section-subtitle {
		color: var(--text-muted);
		font-size: 0.9rem;
	}
	
	.news-grid {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
		gap: 1.5rem;
	}
	
	.news-loading {
		grid-column: 1 / -1;
		text-align: center;
		padding: 3rem;
		color: var(--text-muted);
	}
	
	.news-card {
		background: var(--bg-secondary);
		border-radius: var(--radius-xl);
		overflow: hidden;
		border: 1px solid rgba(255, 255, 255, 0.05);
		transition: all var(--transition-base);
		display: flex;
		flex-direction: column;
	}
	
	.news-card:hover {
		transform: translateY(-4px);
		box-shadow: var(--shadow-xl);
		border-color: rgba(59, 130, 246, 0.3);
	}
	
	.news-image {
		width: 100%;
		aspect-ratio: 16/9;
		background: var(--bg-tertiary);
		overflow: hidden;
	}
	
	.news-image img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		transition: transform var(--transition-slow);
	}
	
	.news-card:hover .news-image img {
		transform: scale(1.05);
	}
	
	.news-content {
		padding: 1.25rem;
		flex: 1;
		display: flex;
		flex-direction: column;
	}
	
	.news-source {
		font-size: 0.75rem;
		color: var(--accent-light);
		text-transform: uppercase;
		letter-spacing: 0.05em;
		margin-bottom: 0.5rem;
	}
	
	.news-title {
		font-size: 1rem;
		font-weight: 600;
		color: var(--text-primary);
		line-height: 1.4;
		margin: 0;
		flex: 1;
	}
	
	.news-title a {
		color: inherit;
		text-decoration: none;
	}
	
	.news-title a:hover {
		color: var(--accent-light);
	}
	
	.news-date {
		font-size: 0.75rem;
		color: var(--text-muted);
		margin-top: 0.75rem;
	}
	
	.news-sources {
		margin-top: 2rem;
		text-align: center;
		font-size: 0.8rem;
		color: var(--text-muted);
	}
	
	@media (max-width: 640px) {
		.news-grid {
			grid-template-columns: 1fr;
		}
	}
</style>

<script>
	// RSS to JSON proxy (using rss2json.com - free tier)
	const RSS2JSON_API = 'https://api.rss2json.com/v1/api.json?rss_url=';
	
	const NEWS_FEEDS = [
		{ name: 'Star Tribune', url: 'https://www.startribune.com/local/index.rss2' },
		{ name: 'MPR News', url: 'https://www.mprnews.org/feed' },
		{ name: 'KARE 11', url: 'https://www.kare11.com/feeds/syndication/rss/news/local' },
	];
	
	// Fallback placeholder images for news without images
	const PLACEHOLDER_IMAGES = [
		'https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?w=400&h=225&fit=crop', // Minneapolis skyline
		'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=400&h=225&fit=crop', // City buildings
		'https://images.unsplash.com/photo-1517732306149-e8f829eb588a?w=400&h=225&fit=crop', // News concept
	];
	
	async function fetchNews() {
		const grid = document.getElementById('news-grid');
		const allNews = [];
		
		try {
			// Fetch from multiple RSS feeds
			const fetchPromises = NEWS_FEEDS.map(async (feed) => {
				try {
					const response = await fetch(RSS2JSON_API + encodeURIComponent(feed.url));
					const data = await response.json();
					
					if (data.items) {
						return data.items.slice(0, 3).map(item => ({
							title: item.title,
							link: item.link,
							source: feed.name,
							image: item.enclosure?.link || item.thumbnail || extractImageFromContent(item.content || item.description),
							pubDate: item.pubDate
						}));
					}
				} catch (e) {
					console.warn(`Failed to fetch ${feed.name}:`, e);
				}
				return [];
			});
			
			const results = await Promise.all(fetchPromises);
			results.forEach(items => allNews.push(...items));
			
			if (allNews.length === 0) {
				// Show fallback message
				grid.innerHTML = `
					<div class="news-loading">
						<p>Unable to load news. <a href="https://www.startribune.com" target="_blank" style="color: var(--accent-light);">Visit Star Tribune â†’</a></p>
					</div>
				`;
				return;
			}
			
			// Sort by date and take top 6
			allNews.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
			const topNews = allNews.slice(0, 6);
			
			// Render news cards
			grid.innerHTML = topNews.map((item, index) => `
				<article class="news-card">
					<div class="news-image">
						<img 
							src="${item.image || PLACEHOLDER_IMAGES[index % PLACEHOLDER_IMAGES.length]}" 
							alt="" 
							loading="lazy"
							onerror="this.src='${PLACEHOLDER_IMAGES[index % PLACEHOLDER_IMAGES.length]}'"
						/>
					</div>
					<div class="news-content">
						<span class="news-source">${item.source}</span>
						<h3 class="news-title">
							<a href="${item.link}" target="_blank" rel="noopener noreferrer">
								${item.title}
							</a>
						</h3>
						<span class="news-date">${formatDate(item.pubDate)}</span>
					</div>
				</article>
			`).join('');
			
		} catch (error) {
			console.error('News fetch failed:', error);
			grid.innerHTML = `
				<div class="news-loading">
					<p>Unable to load news. Check back later.</p>
				</div>
			`;
		}
	}
	
	function extractImageFromContent(content) {
		if (!content) return null;
		const match = content.match(/<img[^>]+src=["']([^"']+)["']/);
		return match ? match[1] : null;
	}
	
	function formatDate(dateString) {
		if (!dateString) return '';
		const date = new Date(dateString);
		const now = new Date();
		const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
		
		if (diffHours < 1) return 'Just now';
		if (diffHours < 24) return `${diffHours}h ago`;
		if (diffHours < 48) return 'Yesterday';
		return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
	}
	
	// Fetch news on load
	fetchNews();
	
	// Refresh every 15 minutes
	setInterval(fetchNews, 15 * 60 * 1000);
</script>
